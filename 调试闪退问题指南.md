# 调试与避坑指南

本指南汇总了项目开发中遇到的常见 Crash、白屏、布局溢出及交互卡死问题，并提供了 AI 编码提示词（Prompt）以避免重蹈覆辙。

## 🔍 查看错误日志

### 方法1：使用Flutter命令查看日志（推荐）

```bash
# 连接设备后运行
flutter logs

# 或者只查看错误
flutter logs | grep -i error
```

### 方法2：使用adb查看Android日志

```bash
# 查看所有日志
adb logcat

# 只查看Flutter相关日志
adb logcat | grep flutter

# 只查看错误和异常
adb logcat *:E flutter:*

# 清除日志后重新运行
adb logcat -c
flutter run
```

---

## 🧱 常见“白屏/页面进不去”原因（布局/渲染断言）

> 这类问题**看起来像“数据加载失败/没报错”**，但本质是 Flutter 在 **layout 阶段断言失败**，导致整棵渲染树无法完成布局，从而页面白屏。

### 1) BoxConstraints forces an infinite width（无限宽约束）

- **典型日志**:
  - `BoxConstraints forces an infinite width.`
  - `The relevant error-causing widget was: ElevatedButton ...`
- **含义**: 某个组件（常见：`ElevatedButton`、`Row` 内子组件）在布局时拿到了 `w=Infinity` 的约束，Flutter 无法计算尺寸，直接抛异常。
- **高频场景**:
  - `Row` / `Column` + `Spacer` + `Button`，但中间区域没有 `Expanded/Flexible` 收敛宽度
  - `SingleChildScrollView` / `ListView` / `Stack` 等组合下，子组件间约束传递不完整
- **修复思路（核心：给有限宽度）**:
  - 用 `Expanded/Flexible` 包住“可伸缩”的内容区（如标题/说明文字）
  - 给按钮用 `SizedBox(width: xx, height: xx)` 或 `ConstrainedBox` 明确尺寸

### 2) RenderBox was not laid out / hasSize（未完成布局）

- **典型日志**:
  - `RenderBox was not laid out: ... hasSize`
  - `Cannot hit test a render box with no size.`
- **修复思路**:
  - 优先找到 **第一条异常**（后面大量 “Another exception…” 都是连锁反应）
  - 检查 widget 是否在 `Stack/Positioned`、`ScrollView`、动画容器等中缺少尺寸约束

---

## 🕸️ Flutter Web 特有交互陷阱 (NEW)

> Flutter Web (CanvasKit/HTML) 在处理复杂层级和动画时，比 Mobile 端更容易出现 HitTest（点击检测）异常。

### 1) 动画组件导致的交互卡死 (HitTest 递归/死循环)

- **症状**:
  - 页面加载后无法点击任何元素。
  - 鼠标移动时，控制台狂刷 `hitTest` 相关日志 (proxy_box.dart)。
  - 看起来像死机，但界面可能有微弱动画。
- **原因**:
  - 某些第三方动画库（如 `animate_do` 的 `FadeInUp` / `SlideTransition`）在 Web 端与 `Stack` 或 `ListView` 结合时，可能导致渲染树的 HitTest 逻辑陷入死循环或层级计算错误。
  - `RenderFractionalTranslation` 在 Web 上的兼容性问题。
- **解决方案**:
  - **移除动画**: 遇到诡异的“不可点击”问题，第一步先移除外层的动画组件（如 `FadeInUp`）。
  - **使用简单实现**: 用原生的 `Transform.translate` 替代复杂的 `SlideTransition`。
  - **避免过度嵌套**: 不要在 `ListView` 的每个 item 里都包裹复杂的动画组件，尤其是在 Web 端。

### 2) Stack + Positioned 点击穿透/遮挡

- **症状**:
  - 按钮明明在最上层，但点击无效。
  - 鼠标经过时没有 Hover 效果。
- **原因**:
  - `Stack` 中的透明区域可能拦截了事件。
  - 某些 `Positioned` 元素尺寸计算错误（如宽/高为 0 或无限大），导致 HitTest 无法命中。
- **解决方案 (最佳实践)**:
  - **优先使用线性布局**: 能用 `Column` / `Row` 解决的，绝对不要用 `Stack`。
  - **线性布局更稳健**: `Column` + `Align` 远比 `Stack` + `Positioned` 不容易出 Bug。
  - 如果必须用 `Stack`，确保 `Positioned` 元素有明确的宽高，且位于 children 列表的最后（最上层）。

---

## 📐 布局溢出与数值适配 (NEW)

### 1) 大额数值溢出 (100000000.00)

- **场景**: 钱包余额、粉丝数等动态长度文本。
- **问题**: 金额过大时，`Text` 会自动换行或溢出父容器，导致布局错乱或 Crash。
- **解决方案**:
  - 强制单行 + 自动缩放：
    ```dart
    FittedBox(
      fit: BoxFit.scaleDown,
      child: Text(balance.toString()),
    )
    ```

### 2) 屏幕高度不足导致的 Overflow

- **场景**: 在小屏幕手机或 Web 缩放窗口下，使用了 `Expanded` 强行撑满屏幕。
- **问题**: `A RenderFlex overflowed by xx pixels`.
- **解决方案**:
  - 移除强制撑满的 `Expanded`。
  - 外层包裹 `SingleChildScrollView`，让页面可滚动。
  - 使用 `LayoutBuilder` 判断屏幕高度，动态调整布局。

---

## 🤖 AI 编码提示词 (System Prompts)

> 将以下提示词添加到 AI 的 Context 或 Custom Rules 中，可避免类似 Bug。

```markdown
# Flutter Web 开发避坑指南

## 1. 布局稳定性优先
- **原则**: 优先使用 `SingleChildScrollView` + `Column` 布局，避免在非固定高度容器中滥用 `Expanded`。
- **禁止**: 不要在 `Stack` 中过度依赖 `Positioned` 进行复杂布局，优先使用 `Column/Row` + `Align`。
- **数值适配**: 所有可能变长的数字/金额文本，**必须**包裹在 `FittedBox(fit: BoxFit.scaleDown)` 中。

## 2. Web 兼容性检查
- **动画慎用**: 在 Web 平台，尽量减少 `FadeInUp` / `SlideTransition` 的使用，特别是包裹 `ListView` Item 或复杂交互组件时。若发现点击失效/卡死，优先移除动画。
- **HitTest 异常**: 如果控制台狂刷 `hitTest` 日志，立即检查是否在 `Stack` 中使用了不当的 Layer 或动画，改回线性布局。

## 3. 错误处理
- **白屏防护**: 全局配置 `ErrorWidget.builder`，当发生 Layout 错误时显示红屏/错误卡片，而不是白屏。
- **日志**: 使用 `debugPrint` 替代 `print`，并对长 JSON 进行截断，防止控制台卡死。
```

---

## 🔧 已添加的调试功能

### 1. 启动日志
应用启动时会输出：
- 🚀 App starting...
- 📱 Platform: android/ios/web
- 🌐 API Base URL: http://...

### 2. 全局错误卡片 (ErrorWidget)
当发生渲染错误时，屏幕会显示：
> "页面渲染出错啦 (；´д｀)ゞ"
> 提示：这通常不是接口数据问题，而是布局约束导致的 RenderBox 未完成 layout。

---

## 📝 调试步骤

1. **看第一条红字**: 忽略后面的一堆报错，只看第一条。
2. **找文件行号**: 定位到具体的 `Column` / `Row` / `Button`。
3. **检查约束**: 是否在无限宽/高的地方用了 `Expanded`？是否用了 `Stack` 但没给尺寸？
4. **移除动画**: 如果是 Web 端点击没反应，先注释掉动画组件试试。
